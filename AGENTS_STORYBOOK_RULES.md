# AGENTS_STORYBOOK_RULES - Storybook / デザインシステム運用規約

> このドキュメントは、**Storybook によるデザインシステム管理のための共通規約**と、  
> **LLM エージェントが絶対に守るべき具体的な実行ルール**を定義します。  
> ワークフロー全体の規約は [`AGENTS.md`](./AGENTS.md)、  
> LLM 向けの全体ルールは [`AGENTS_AI_PLAYBOOK.md`](./AGENTS_AI_PLAYBOOK.md) を参照してください。

---

## クイックリファレンス（絶対に守ること）

1. **Storybook は「論理構造」で管理する**

   - 階層名・階層順・public/admin の対称構造は変更禁止
   - デザイントークンとコンポーネントを混ぜない

2. **デザイントークンは「01\_デザイン基盤」が唯一の正**

   - トークン定義は `01_デザイン基盤（MDX）` のみに記載
   - コンポーネント側ではトークンを「参照するだけ」（定義しない）

3. **UI は「役割 → 状態 → 構造 → 見た目」の順で定義する**

   - 見た目の話は最後
   - 見た目の根拠は必ずトークンに遡れる

4. **コンポーネントの記述順を守る**

   - 概要 → 役割 → 状態一覧 → 振る舞い → 構造 → 使用トークン → アクセシビリティ → 使用上の注意

5. **すべてのコンポーネントに Storybook ストーリーを作成する**
   - `*.stories.tsx` 形式で対象コンポーネントと同じディレクトリに配置
   - `tags: ['autodocs']` を追加して自動ドキュメント生成を有効にする

---

## 対象と前提

### この規約がカバーするもの

- Storybook の論理構造と階層定義
- デザイントークンの管理ルール
- コンポーネントの記述方法とテンプレート
- UI Stack との対応関係
- **LLM エージェントが Storybook を生成するときのチェックリスト**

---

## Storybook 論理構造（固定）

Storybook は以下の論理構造で管理します。**階層名・階層順・public/admin の対称構造は変更禁止**です。

```
イントロダクション（MDX）

フロント（public）
  01_デザイン基盤（MDX）
  02_最小UI部品
  03_UIコンポーネント
  04_画面パターン
  05_レイアウト雛形
  06_画面例（URI）

管理画面（admin）
  01_デザイン基盤（MDX）
  02_最小UI部品
  03_UIコンポーネント
  04_画面パターン
  05_レイアウト雛形
  06_画面例（URI）
```

### 変更禁止事項

- 階層名（`01_デザイン基盤`、`02_最小UI部品` など）
- 階層順（01 → 06 の順序）
- public / admin の対称構造

---

## 各階層の役割

### イントロダクション（MDX）

**目的**: Storybook 全体の読み方と設計思想を説明する。

**含まれるもの**:

- Storybook 全体の読み方
- 設計思想
- public / admin の違い
- 参照順（01 → 06）

**禁止事項**:

- UI コンポーネントを置かない
- 個別コンポーネントの仕様を書かない

---

### 01\_デザイン基盤（MDX）【唯一の正】

**目的**: デザイントークンの定義と使用ルールを集約する。**デザインの憲法**として機能する。

#### ここに書くもの ✅

- **デザイントークンの定義**
  - 色（semantic / primitive の区別）
  - 文字（タイポグラフィ）
  - 余白（スペーシング）
  - 動き（アニメーション、トランジション）
  - その他（シャドウ、ボーダー、ラディウス等）
- **semantic / primitive の区別**
- **使用ルール**
- **禁止ルール**
- **アクセシビリティ基準**

#### 書いてはいけない ❌

- 個別コンポーネントの仕様
- UI の組み合わせ
- URI
- カラーコードや px / rem 値の直接記載（トークン名で参照）

👉 **デザイントークンはここが唯一の正。コンポーネント側では参照するだけ。**

---

### 02\_最小 UI 部品

**目的**: これ以上分解できない最小単位の UI を定義する。

**定義**: 見た目ではなく「役割」で定義する。

**例**:

- ボタン（`Button`）
- テキスト（`Text`、`Heading`）
- 入力欄（`Input`、`Textarea`）
- チェックボックス（`Checkbox`）
- ラジオボタン（`Radio`）
- レイアウト部品（`Box`、`Flex`、`Grid` 等）

**特徴**:

- 単一の役割を持つ
- 他の最小 UI 部品に依存しない
- 状態（disabled、loading、error 等）を持つ

---

### 03_UI コンポーネント

**目的**: 業務・画面で直接使う部品を定義する。

**定義**: 複数の最小 UI 部品を組み合わせて実現する。

**例**:

- フォーム行（`FormRow`、`FormField`）
- モーダル（`Modal`、`Dialog`）
- テーブル（`Table`、`DataTable`）
- ナビゲーション（`Nav`、`Breadcrumb`）
- カード（`Card`）
- アコーディオン（`Accordion`）

**特徴**:

- 複数の最小 UI 部品を組み合わせる
- 業務ロジックに近い
- 画面で直接使用される

---

### 04\_画面パターン

**目的**: UI コンポーネントの組み合わせ例を定義する。再利用可能な「画面の型」を提供する。

**例**:

- 一覧＋検索（`ListWithSearch`）
- CRUD フロー（`CRUDFlow`）
- 認証フロー（`AuthFlow`）
- マルチステップフォーム（`MultiStepForm`）

**特徴**:

- 複数の UI コンポーネントを組み合わせる
- 再利用可能なパターン
- 画面の「型」を定義

---

### 05\_レイアウト雛形

**目的**: 画面骨格のみを定義する。中身は入れない。

**例**:

- サイドバー型（`SidebarLayout`）
- ヘッダー＋一覧型（`HeaderListLayout`）
- フルスクリーン型（`FullScreenLayout`）

**特徴**:

- 画面の骨格のみ
- 中身（コンテンツ）は含まない
- レイアウト構造のテンプレート

---

### 06\_画面例（URI）

**目的**: 実際の URL 構造に合わせた完成形を定義する。最終確認・共有用。

**ルール**:

- UI の正は **02〜05**
- 仕様説明を書かない
- 見た目・導線確認のみ

**特徴**:

- 実際の URL 構造に合わせる
- 完成形の画面
- 最終確認・共有用

---

## デザイントークンの絶対ルール

### トークンの置き場所

**重要**: デザイントークンの定義は **`01_デザイン基盤（MDX）` のみ**に記載する。

### コンポーネント側の扱い

**原則**: コンポーネント側ではトークンを「定義しない」。トークンは「参照するだけ」。

#### 書いてよい ✅

- 使用している semantic トークン名（例: `colors.semantic.primary`）
- 状態ごとのトークン切り替え理由（例: 「hover 時は `colors.semantic.primaryHover` を使用」）

#### 書いてはいけない ❌

- カラーコード（例: `#FF0000`）
- px / rem 値（例: `16px`、`1rem`）
- easing の数値（例: `cubic-bezier(0.4, 0, 0.2, 1)`）
- 新しいトークン定義（`01_デザイン基盤` に追加すべき）

### トークンの種類

#### Semantic トークン

**定義**: 意味に基づくトークン（例: `primary`、`danger`、`success`）

**使用例**:

- `colors.semantic.primary`
- `colors.semantic.danger`
- `spacing.semantic.small`

#### Primitive トークン

**定義**: 原始的な値（例: `red-500`、`16px`）

**使用例**:

- `colors.primitive.red-500`
- `spacing.primitive.16`

**注意**: 通常は semantic トークンを使用し、primitive トークンは直接使用しない。

---

## コンポーネントの書き方（固定テンプレート）

### 記述順（必須）

コンポーネントの Storybook ストーリーは、以下の順序で記述する：

1. **概要**

   - コンポーネントの目的と役割を簡潔に説明

2. **役割（何を伝える UI か）**

   - ユーザーに何を伝える UI なのか
   - どのような場面で使用するか

3. **状態一覧（意味ベース）**

   - コンポーネントが持つ状態を意味ベースで列挙
   - 例: `default`、`hover`、`active`、`disabled`、`loading`、`error`

4. **振る舞い（状態遷移）**

   - 状態間の遷移ルール
   - インタラクション（クリック、ホバー等）

5. **構造（要素の構成）**

   - コンポーネントの内部構造
   - 子要素の役割

6. **使用トークン（参照のみ）**

   - 使用している semantic トークン名を列挙
   - 状態ごとのトークン切り替え理由

7. **アクセシビリティ**

   - `aria-*` 属性の使用
   - キーボード操作の対応
   - スクリーンリーダー対応

8. **使用上の注意**
   - 使用時の注意事項
   - 禁止事項

👉 **見た目の話（色コード、px 値等）は最後。見た目の根拠は必ずトークンに遡れる。**

### テンプレート例

```typescript
// Button.stories.tsx
import type { Meta, StoryObj } from "@storybook/react";
import { Button } from "./Button";

const meta: Meta<typeof Button> = {
  title: "02_最小UI部品/Button",
  component: Button,
  tags: ["autodocs"],
  parameters: {
    docs: {
      description: {
        component: `
## 概要
ボタンコンポーネント。ユーザーの操作をトリガーする UI 要素。

## 役割
ユーザーに「クリック可能な操作」を伝える UI。主な操作（送信、保存、削除等）を実行する。

## 状態一覧
- \`default\`: 通常状態
- \`hover\`: マウスホバー時
- \`active\`: クリック時
- \`disabled\`: 無効状態
- \`loading\`: 読み込み中

## 振る舞い
- クリック時に \`onClick\` が発火
- \`disabled\` 時はクリック不可
- \`loading\` 時はクリック不可かつローディング表示

## 構造
- テキストラベル（必須）
- アイコン（オプション）
- ローディングスピナー（\`loading\` 時）

## 使用トークン
- \`colors.semantic.primary\`: 通常状態の背景色
- \`colors.semantic.primaryHover\`: ホバー時の背景色
- \`spacing.semantic.small\`: 内部余白

## アクセシビリティ
- \`aria-label\` またはテキストラベルで操作内容を明示
- キーボード操作（Enter、Space）に対応
- フォーカスインジケーターを表示

## 使用上の注意
- テキストラベルは必須（アイコンのみのボタンは \`aria-label\` を必須）
- \`disabled\` 時は操作不可であることを視覚的に明示
        `,
      },
    },
  },
};

export default meta;
type Story = StoryObj<typeof Button>;

export const Default: Story = {
  args: {
    children: "Button",
    variant: "primary",
  },
};

export const Disabled: Story = {
  args: {
    children: "Button",
    variant: "primary",
    disabled: true,
  },
};

export const Loading: Story = {
  args: {
    children: "Button",
    variant: "primary",
    loading: true,
  },
};
```

---

## UI Stack との対応

UI Stack の各要素と Storybook の配置場所の対応関係：

| UI Stack       | 置き場所         | 説明                                                                              |
| -------------- | ---------------- | --------------------------------------------------------------------------------- |
| 役割           | コンポーネント   | コンポーネントの役割は各コンポーネントの Storybook に記載                         |
| 状態           | コンポーネント   | コンポーネントの状態は各コンポーネントの Storybook に記載                         |
| 構造           | コンポーネント   | コンポーネントの構造は各コンポーネントの Storybook に記載                         |
| 見た目のルール | 01\_デザイン基盤 | 見た目のルール（トークン定義）は `01_デザイン基盤` に記載                         |
| 数値・色       | トークンのみ     | 数値・色はトークンとして `01_デザイン基盤` に定義し、コンポーネント側では参照のみ |

---

## 禁止事項（違反扱い）

以下の行為は禁止です：

- **コンポーネント内でトークン定義**
  - トークン定義は `01_デザイン基盤` のみに記載
- **Story に色コードを書く**
  - 色コードは直接記載せず、トークン名で参照
- **06\_画面例に仕様を書く**
  - `06_画面例` は見た目・導線確認のみ。仕様説明は不要
- **見た目だけで状態を定義**
  - 状態は意味ベースで定義し、見た目はトークンに遡る
- **「なんとなく共通」を作る**
  - 共通化する場合は明確な理由と役割を定義

---

## LLM エージェント向け実行ルール（必須）

> ここから下は、**AI が Storybook を生成するときに絶対に守るチェックリスト**です。

> `AGENTS_AI_PLAYBOOK.md` のルールに **追加される Storybook 専用縛り** として扱います。

### 共通前提

- すべての Storybook 対応は、`AGENTS_AI_PLAYBOOK.md` のワークフロー
  （`.workflow/{YYYYMMDD_HHMMSS_issue_name}/` 配下の `00_要求定義.md` → `01_要件定義.md` → …）に従う。
- この `AGENTS_STORYBOOK_RULES.md` は **参照しながら作業することが前提**。
  Storybook を生成するときは、まずここに合致するかを確認する。

### 1. Storybook 論理構造の遵守

AI は Storybook を生成するとき、**必ず次を守る**：

- **階層構造**: イントロダクション → public/admin → 01*デザイン基盤 → 02*最小 UI 部品 → … → 06\_画面例 の順序を守る
- **階層名**: `01_デザイン基盤`、`02_最小UI部品` などの階層名を変更しない
- **対称構造**: public と admin は対称構造を維持する

**禁止事項**:

- 階層名の変更
- 階層順の変更
- public / admin の非対称構造

### 2. デザイントークンの管理

AI はデザイントークンを扱うとき、**必ず次を守る**：

- **トークン定義**: トークン定義は `01_デザイン基盤（MDX）` のみに記載
- **コンポーネント側**: コンポーネント側ではトークンを「参照するだけ」（定義しない）
- **トークン名の使用**: 色コードや px 値を直接記載せず、トークン名で参照

**禁止事項**:

- コンポーネント内でトークン定義
- Story に色コードを書く
- 新しいトークンを `01_デザイン基盤` に追加せずに使用

### 3. コンポーネントの記述順

AI はコンポーネントの Storybook を生成するとき、**必ず次を守る**：

- **記述順**: 概要 → 役割 → 状態一覧 → 振る舞い → 構造 → 使用トークン → アクセシビリティ → 使用上の注意
- **見た目の話は最後**: 見た目の話（色コード、px 値等）は最後に記載
- **トークンへの遡及**: 見た目の根拠は必ずトークンに遡れる

**禁止事項**:

- 記述順の変更
- 見た目の話を最初に書く
- トークンに遡れない見た目の記載

### 4. コンポーネントの配置判断

AI はコンポーネントを配置するとき、**必ず次の判断フローに従う**：

```
これは何か？
↓
見た目のルールか？
  → YES → 01_デザイン基盤
  → NO
↓
最小単位か？
  → YES → 02_最小UI部品
  → NO
↓
業務で直接使うか？
  → YES → 03_UIコンポーネント
  → NO
↓
組み合わせ例か？
  → YES → 04_画面パターン
  → NO
↓
骨格か？
  → YES → 05_レイアウト雛形
  → NO
↓
URI に紐づく完成形か？
  → YES → 06_画面例
```

### 5. Storybook ストーリーの必須項目

AI は Storybook ストーリーを生成するとき、**必ず次を守る**：

- **配置場所**: `*.stories.tsx` 形式で対象コンポーネントと同じディレクトリに配置
- **必須項目**:
  - `tags: ['autodocs']` を追加して自動ドキュメント生成を有効にする
  - `Meta` と `StoryObj` を使用して、適切なストーリーを定義する
  - コンポーネントの主要なバリアントや状態を Storybook で確認可能にする
- **対象コンポーネント**: すべてのコンポーネント（`01-web-components/`、`02-providers/`、`03-features/`、`04-domains/`、`05-shared/`、`06-ui/` 配下など、プロジェクトの構成に応じて）

**禁止事項**:

- Storybook ストーリーを作成しない（すべてのコンポーネントに Storybook ストーリーは必須）
- Storybook ファイルを別ディレクトリに配置する（対象コンポーネントと同じディレクトリに配置）

### 6. 参照パス確認ルール

AI は Storybook 生成時にドキュメントを生成するとき、**必ず次を守る**：

- **参照パス確認は必須**: ドキュメント作成・更新時は、**必ずすべての参照パスが正しいか確認すること**
- **確認タイミング**: ドキュメント作成時、更新時、レビュー時
- **確認方法**: すべての参照パス（Markdown リンク形式）を確認し、実際のファイルパスと一致しているか検証する
- **確認項目**:
  - 相対パスの形式が正しいか（`./`、`../` など）
  - ファイル名が正しいか（大文字小文字、拡張子を含む）
  - ディレクトリ構造が正しいか
  - リンク形式が正しいか（Markdown リンク形式: `[テキスト](./パス)`）
- **禁止事項**:
  - 参照パスを推測する
  - ファイル名を記憶に基づいて記載する
  - ディレクトリ構造を確認せずに参照パスを記載する
  - ファイルが存在しないのに参照パスを記載する
- **必須事項**: 参照パスを記載する前に、必ず実際のファイルパスを確認する
- **詳細**: 参照パス確認の詳細なルールは [`AGENTS.md`](./AGENTS.md) の「ドキュメント原則」セクションを参照

---

## AI 自己チェックリスト（生成前に必ず確認）

> **重要**: AI は、Storybook を生成する前に、**必ず以下のチェックリストを自問自答し、すべての項目を確認すること**。

### Storybook 生成時の自己チェック

Storybook を生成する前に、以下を確認：

- [ ] **論理構造**: 階層構造（イントロダクション → public/admin → 01*デザイン基盤 → … → 06*画面例）を守っているか？
- [ ] **階層名**: 階層名（`01_デザイン基盤`、`02_最小UI部品` など）を変更していないか？
- [ ] **対称構造**: public と admin は対称構造を維持しているか？
- [ ] **トークン定義**: トークン定義は `01_デザイン基盤（MDX）` のみに記載しているか？
- [ ] **コンポーネント側**: コンポーネント側ではトークンを「参照するだけ」にしているか？（定義していないか？）
- [ ] **色コード**: Story に色コードを直接記載していないか？（トークン名で参照しているか？）
- [ ] **記述順**: コンポーネントの記述順（概要 → 役割 → 状態一覧 → 振る舞い → 構造 → 使用トークン → アクセシビリティ → 使用上の注意）を守っているか？
- [ ] **見た目の話**: 見た目の話（色コード、px 値等）を最後に記載しているか？
- [ ] **トークンへの遡及**: 見た目の根拠は必ずトークンに遡れるか？
- [ ] **配置判断**: コンポーネントの配置判断フローに従っているか？
- [ ] **Storybook ストーリー**: すべてのコンポーネントに Storybook ストーリーを作成しているか？
- [ ] **配置場所**: Storybook ファイルは対象コンポーネントと同じディレクトリに `*.stories.tsx` 形式で配置しているか？
- [ ] **必須項目**: `tags: ['autodocs']` を追加し、`Meta` と `StoryObj` を使用しているか？
- [ ] **参照パス**: 生成するドキュメント内のすべての参照パスが正しいか？（Markdown リンク形式、相対パス、ファイル名、ディレクトリ構造を確認）

### チェックリストの使い方

1. **生成前に確認**: Storybook を生成する前に、上記のチェックリストを確認する
2. **不備があれば修正**: チェックリストの項目に不備があれば、生成前に修正する
3. **確認結果を明示**: 生成物と一緒に「自己チェック結果」を簡潔に記載する（例: 「✅ 論理構造遵守、トークン定義は 01\_デザイン基盤のみ、記述順遵守、Storybook ストーリー作成済み」）

---

## 判断フロー（AI が迷ったとき）

AI がコンポーネントの配置に迷ったときは、以下の判断フローに従う：

```
これは何か？
↓
見た目のルールか？
  → YES → 01_デザイン基盤（MDX）
  → NO
↓
最小単位か？
  → YES → 02_最小UI部品
  → NO
↓
業務で直接使うか？
  → YES → 03_UIコンポーネント
  → NO
↓
組み合わせ例か？
  → YES → 04_画面パターン
  → NO
↓
骨格か？
  → YES → 05_レイアウト雛形
  → NO
↓
URI に紐づく完成形か？
  → YES → 06_画面例（URI）
```

### 判断基準の詳細

#### 見た目のルールか？

- **YES**: 色、文字、余白、動きなどのデザイントークンの定義や使用ルール
- **NO**: 個別コンポーネントの仕様、UI の組み合わせ

#### 最小単位か？

- **YES**: これ以上分解できない UI（ボタン、テキスト、入力欄等）
- **NO**: 複数の最小 UI 部品を組み合わせたもの

#### 業務で直接使うか？

- **YES**: 画面で直接使用される部品（フォーム行、モーダル、テーブル等）
- **NO**: 最小単位の UI や、組み合わせ例

#### 組み合わせ例か？

- **YES**: 複数の UI コンポーネントを組み合わせた再利用可能なパターン
- **NO**: 単一の UI コンポーネントや、骨格

#### 骨格か？

- **YES**: 画面の骨格のみ（中身を含まない）
- **NO**: 中身を含む完成形

#### URI に紐づく完成形か？

- **YES**: 実際の URL 構造に合わせた完成形の画面
- **NO**: 骨格やパターン

---

## 最終宣言（AI 用）

> - デザイントークンは **01\_デザイン基盤が唯一の正**
> - コンポーネントは **役割と状態を語る**
> - 見た目の根拠は **必ずトークンに遡れる**
> - Storybook は **設計書であり、カタログではない**

---

## 参考資料

### プロジェクトドキュメント

- [`AGENTS_AI_PLAYBOOK.md`](./AGENTS_AI_PLAYBOOK.md) - LLM エージェント運用ルール
- [`AGENTS.md`](./AGENTS.md) - 開発規約の全体像

### 外部参考資料

- [Storybook 公式ドキュメント](https://storybook.js.org/)
- [Storybook MDX ドキュメント](https://storybook.js.org/docs/writing-docs/mdx)
- [Storybook Controls ドキュメント](https://storybook.js.org/docs/essentials/controls)

---

## 最後に（人間向け）

- この `AGENTS_STORYBOOK_RULES.md` は、**Storybook によるデザインシステム管理に特化した規約**です。
- 迷ったときは：
  1. まず判断フローに従う
  2. トークン定義は `01_デザイン基盤` のみ
  3. コンポーネントは役割と状態を語る
  4. 見た目の根拠は必ずトークンに遡る
  5. それでも悩んだら `.workflow/{issue}/memo/` にメモを残してから検討

---

**最終更新**: 2025 年 12 月 20 日（Storybook / デザインシステム運用規約の初版作成）
