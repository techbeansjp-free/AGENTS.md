# AGENTS_REVIEW_RULE.md - レビュー時の徹底的な品質調査ルール

> **重要**: このドキュメントは、レビューフェーズ（`04_review.md`作成時）に AI エージェントが必ず遵守すべき徹底的な品質調査ルールを定義します。

---

## 1. 基本方針

### 1.1 徹底的な品質調査の原則

レビュー時は、**関連するテストやコードだけでなく、プロジェクト全体のすべてのテストやコードを徹底的に調査する**ことが必須です。

**禁止事項**:

- ❌ 実装範囲に関連するファイルのみを確認する
- ❌ エラーや警告が報告されたファイルのみを確認する
- ❌ テスト結果のサマリーのみを確認する
- ❌ ドキュメントの表面的な確認のみを行う

**必須事項**:

- ✅ プロジェクト全体のすべてのテストファイルを確認する
- ✅ プロジェクト全体のすべてのコードファイルを確認する
- ✅ すべてのリントエラーと警告を確認する
- ✅ すべての型エラーを確認する
- ✅ すべてのテストを実行し、結果を確認する
- ✅ コードカバレッジを確認する
- ✅ ドキュメントの整合性を徹底的に確認する

---

## 2. レビュー実施手順

### 2.1 事前準備

レビューを開始する前に、以下の準備を行うこと：

1. **プロジェクト構造の把握**

   - プロジェクトのディレクトリ構造を確認
   - 主要なディレクトリ（`src/`, `app/`, `tests/`, `app/api/`など）を特定
   - 実装範囲に関係なく、すべてのディレクトリを調査対象とする

2. **ツールの準備**
   - リントツール（ESLint、PHP CS Fixer、Laravel Pint など）の実行環境を確認
   - 型チェックツール（TypeScript、PHPStan など）の実行環境を確認
   - テスト実行環境を確認

### 2.2 コード品質調査（必須）

#### 2.2.1 リントエラー・警告の確認

**実施内容**:

1. **すべてのファイルに対してリントを実行**

   - 実装範囲に関係なく、プロジェクト全体のすべてのファイルを対象とする
   - エラーだけでなく、警告もすべて確認する
   - リントツールの出力を完全に確認する

2. **エラー・警告の記録**
   - すべてのエラー・警告を`04_review.md`の「4.2 指摘事項」セクションに記録する
   - 重要度（高/中/低）を判定する
   - 対応方法を提案する

**確認コマンド例**:

```bash
# フロントエンド（TypeScript/JavaScript）
pnpm run lint
pnpm run typecheck

# バックエンド（PHP）
docker compose exec app ./vendor/bin/pint --test
docker compose exec app php artisan test
```

#### 2.2.2 型エラーの確認

**実施内容**:

1. **すべてのファイルに対して型チェックを実行**

   - TypeScript プロジェクトの場合、`tsc --noEmit`を実行
   - PHP プロジェクトの場合、PHPStan や Psalm などの静的解析ツールを実行
   - 実装範囲に関係なく、プロジェクト全体を対象とする

2. **型エラーの記録**
   - すべての型エラーを`04_review.md`の「4.2 指摘事項」セクションに記録する
   - 重要度（高/中/低）を判定する
   - 対応方法を提案する

#### 2.2.3 コードスタイルの確認

**実施内容**:

1. **コードフォーマットの確認**

   - Prettier、PHP CS Fixer、Laravel Pint などのフォーマッターを実行
   - フォーマット違反がないか確認する

2. **コーディング規約の確認**
   - プロジェクトのコーディング規約に準拠しているか確認する
   - 命名規則、インデント、コメントスタイルなどを確認する

### 2.3 テスト品質調査（必須）

#### 2.3.1 すべてのテストの実行

**実施内容**:

1. **すべてのテストを実行**

   - 単体テスト、結合テスト、E2E テストをすべて実行する
   - 実装範囲に関係なく、プロジェクト全体のテストを実行する
   - テスト実行時間も記録する

2. **テスト結果の詳細確認**
   - 成功したテストの数、失敗したテストの数、スキップされたテストの数を記録する
   - 失敗したテストの詳細（テストファイル名、テストケース名、失敗理由）を記録する
   - スキップされたテストの理由を確認する

**確認コマンド例**:

```bash
# フロントエンド
pnpm run test:run

# バックエンド
docker compose exec app php artisan test
```

#### 2.3.2 テストカバレッジの確認

**実施内容**:

1. **コードカバレッジの測定**

   - テストカバレッジツール（Vitest、PHPUnit など）を使用してカバレッジを測定する
   - 実装範囲に関係なく、プロジェクト全体のカバレッジを確認する

2. **カバレッジの分析**
   - カバレッジが低いファイルや関数を特定する
   - クリティカルな機能（課金、認証、データ削除など）のカバレッジを重点的に確認する
   - カバレッジが不足している箇所を`04_review.md`に記録する

#### 2.3.3 テストコードの品質確認

**実施内容**:

1. **すべてのテストファイルを確認**

   - 実装範囲に関係なく、プロジェクト全体のすべてのテストファイルを確認する
   - テストコードの品質（可読性、保守性、適切なアサーションなど）を確認する
   - BDD 形式のコメント（Given-When-Then）が適切に記載されているか確認する

2. **テストの適切性の確認**
   - 各テストが適切な範囲をテストしているか確認する
   - モックやスタブの使用が適切か確認する
   - テストの独立性（他のテストに依存していないか）を確認する

### 2.4 コードレビュー（必須）

#### 2.4.1 すべてのコードファイルの確認

**実施内容**:

1. **実装範囲に関係なく、プロジェクト全体のコードを確認**

   - 変更されたファイルだけでなく、関連するすべてのファイルを確認する
   - 影響を受ける可能性のあるファイルも確認する

2. **コード品質の確認**
   - 可読性、保守性、パフォーマンス、セキュリティの観点からコードを確認する
   - コードの重複、複雑度、依存関係を確認する
   - 設計原則（KISS、YAGNI、SOLID など）に準拠しているか確認する

#### 2.4.2 アーキテクチャの確認

**実施内容**:

1. **設計書との整合性確認**

   - `02_設計.md`で定義されたアーキテクチャと実装が一致しているか確認する
   - 設計書に記載されていない変更がないか確認する

2. **依存関係の確認**
   - 外部ライブラリの依存関係を確認する
   - 不要な依存関係がないか確認する
   - セキュリティ脆弱性がないか確認する（`npm audit`、`composer audit`など）

### 2.5 ドキュメントの確認（必須）

#### 2.5.1 ドキュメントの整合性確認

**実施内容**:

1. **すべてのワークフロードキュメントを確認**

   - `00_要求定義.md`、`01_要件定義.md`、`02_設計.md`、`03_実装計画.md`をすべて確認する
   - 実装内容とドキュメントの整合性を確認する
   - ドキュメントが最新の状態になっているか確認する

2. **ドキュメントの品質確認**
   - ドキュメントが適切に更新されているか確認する
   - ドキュメントの内容が正確で、実装を反映しているか確認する
   - 必要な情報がすべて記載されているか確認する
   - **参照パスの確認（必須）**: すべてのドキュメント内の参照パス（Markdown リンク形式）が正しいか確認する
     - 相対パスの形式が正しいか（`./`、`../` など）
     - ファイル名が正しいか（大文字小文字、拡張子を含む）
     - ディレクトリ構造が正しいか
     - リンク形式が正しいか（Markdown リンク形式: `[テキスト](./パス)`）
     - 参照先のファイルが実際に存在するか

#### 2.5.2 コードコメントの確認

**実施内容**:

1. **すべてのコードファイルのコメントを確認**
   - 実装範囲に関係なく、プロジェクト全体のコードコメントを確認する
   - コメントが適切に記載されているか確認する
   - 古いコメントや不要なコメントがないか確認する

### 2.6 セキュリティ確認（必須）

#### 2.6.1 セキュリティチェック

**実施内容**:

1. **認証・認可の確認**

   - 認証・認可の実装が適切か確認する
   - 権限チェックが適切に行われているか確認する

2. **入力検証の確認**

   - すべての入力に対して適切な検証が行われているか確認する
   - SQL インジェクション、XSS、CSRF などの脆弱性がないか確認する

3. **データ保護の確認**
   - 機密情報が適切に保護されているか確認する
   - 環境変数の管理が適切か確認する

### 2.7 パフォーマンス確認（該当する場合）

#### 2.7.1 パフォーマンステスト

**実施内容**:

1. **パフォーマンステストの実行**

   - 該当する場合、パフォーマンステストを実行する
   - レスポンスタイム、スループット、リソース使用率を確認する

2. **ボトルネックの特定**
   - パフォーマンスのボトルネックを特定する
   - 改善提案を`04_review.md`に記録する

---

## 3. レビュー結果の記録

### 3.1 必須記録項目

`04_review.md`には、以下の項目を必ず記録すること：

1. **テスト結果の詳細**

   - すべてのテストファイルのリスト
   - すべてのテストケースの結果（成功/失敗/スキップ）
   - 失敗したテストの詳細（ファイル名、ケース名、失敗理由、スタックトレース）
   - テスト実行時間

2. **コード品質の詳細**

   - すべてのリントエラー・警告のリスト
   - すべての型エラーのリスト
   - コードカバレッジの詳細（ファイルごと、関数ごと）

3. **指摘事項の詳細**

   - すべての指摘事項を重要度順に記録する
   - 各指摘事項について、対応方法を提案する
   - 対応状況を記録する

4. **ドキュメントの整合性**
   - すべてのワークフロードキュメントの更新状況
   - 実装と設計の整合性
   - 要件と実装の整合性

### 3.2 記録の形式

`04_review.md`のテンプレートに従って、以下の形式で記録すること：

```markdown
## 3. テスト結果の確認

### 3.1 単体テスト

#### テスト実行結果

- **実行日**: {日付}
- **テストファイル数**: {数}（すべてのテストファイルをカウント）
- **テストケース数**: {数}（すべてのテストケースをカウント）
- **成功**: {数}
- **失敗**: {数}
- **スキップ**: {数}

#### 失敗したテスト（該当する場合）

| テストファイル | テストケース | 失敗理由 | 対応状況      |
| -------------- | ------------ | -------- | ------------- |
| {ファイル名}   | {ケース名}   | {理由}   | {対応中/完了} |

## 4. コードレビュー

### 4.1 コード品質

#### コードスタイル

- **リント結果**: {エラー数} / {警告数}（すべてのエラー・警告をカウント）
- **フォーマット**: {問題あり/問題なし}
- **型チェック**: {エラー数} / {警告数}（すべてのエラー・警告をカウント）

### 4.2 指摘事項

#### 指摘 1: {指摘内容}

- **重要度**: {高/中/低}
- **指摘内容**: {詳細}
- **対応状況**: {未対応/対応中/完了}
- **対応方法**: {対応方法}
```

---

## 4. チェックリスト

レビュー実施時は、以下のチェックリストを必ず確認すること：

### 4.1 コード品質チェックリスト

- [ ] すべてのファイルに対してリントを実行した
- [ ] すべてのリントエラー・警告を確認した
- [ ] すべてのファイルに対して型チェックを実行した
- [ ] すべての型エラーを確認した
- [ ] コードフォーマットを確認した
- [ ] コーディング規約に準拠しているか確認した

### 4.2 テスト品質チェックリスト

- [ ] すべてのテストを実行した（単体テスト、結合テスト、E2E テスト）
- [ ] すべてのテスト結果を確認した（成功/失敗/スキップ）
- [ ] 失敗したテストの詳細を確認した
- [ ] テストカバレッジを測定した
- [ ] すべてのテストファイルを確認した
- [ ] テストコードの品質を確認した

### 4.3 コードレビューチェックリスト

- [ ] 実装範囲に関係なく、プロジェクト全体のコードを確認した
- [ ] コードの可読性、保守性、パフォーマンス、セキュリティを確認した
- [ ] 設計書との整合性を確認した
- [ ] 依存関係を確認した

### 4.4 ドキュメントチェックリスト

- [ ] すべてのワークフロードキュメントを確認した
- [ ] 実装内容とドキュメントの整合性を確認した
- [ ] ドキュメントが最新の状態になっているか確認した
- [ ] すべてのコードファイルのコメントを確認した
- [ ] **参照パス**: すべてのドキュメント内の参照パスが正しいか？（Markdown リンク形式、相対パス、ファイル名、ディレクトリ構造を確認）

### 4.5 セキュリティチェックリスト

- [ ] 認証・認可の実装を確認した
- [ ] 入力検証を確認した
- [ ] データ保護を確認した
- [ ] セキュリティ脆弱性を確認した

---

## 5. 注意事項

### 5.1 実装範囲の誤解を避ける

**重要**: 実装範囲に関連するファイルのみを確認するのではなく、**プロジェクト全体のすべてのファイルを確認する**ことが必須です。

理由:

- 実装範囲外のファイルにも影響がある可能性がある
- 既存のコードに問題がある可能性がある
- テストが実装範囲外の機能もカバーしている可能性がある

### 5.2 エラー・警告の見落としを避ける

**重要**: エラーや警告が報告されたファイルのみを確認するのではなく、**すべてのファイルに対してリントと型チェックを実行する**ことが必須です。

理由:

- エラー・警告が報告されていないファイルにも問題がある可能性がある
- リントツールや型チェッカーの設定が変更されている可能性がある
- 新しいエラー・警告が発生している可能性がある

### 5.3 テスト結果の表面的な確認を避ける

**重要**: テスト結果のサマリーのみを確認するのではなく、**すべてのテストファイルとテストケースを詳細に確認する**ことが必須です。

理由:

- テストが適切に実装されているか確認する必要がある
- テストカバレッジが十分か確認する必要がある
- テストコードの品質を確認する必要がある

---

## 6. 参考資料

### 6.1 関連ドキュメント

- [`AGENTS.md`](./AGENTS.md) - プロジェクト規約の完全版
- [`AGENTS_AI_PLAYBOOK.md`](./AGENTS_AI_PLAYBOOK.md) - AI エージェント向けの実行ルール
- [`AGENTS_TEST_GUIDELINES.md`](./AGENTS_TEST_GUIDELINES.md) - テスト作成ガイドライン
- [`.workflow/templates/04_review.md`](../.workflow/templates/04_review.md) - レビュー書のテンプレート

### 6.2 ツールのドキュメント

- [ESLint 公式ドキュメント](https://eslint.org/)
- [TypeScript 公式ドキュメント](https://www.typescriptlang.org/)
- [Vitest 公式ドキュメント](https://vitest.dev/)
- [PHPUnit 公式ドキュメント](https://phpunit.de/)
- [Laravel Pint 公式ドキュメント](https://laravel.com/docs/pint)

---

**最終更新**: 2025 年 12 月 07 日
