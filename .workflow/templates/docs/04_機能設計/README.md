---

このドキュメントは、複雑なロジックやバッチ処理を定義します。  
システム仕様書作成ルールは [`AGENTS_DOCS_RULES.md`](../../../AGENTS_DOCS_RULES.md) を参照してください。  
Mermaid 図作成時は [`AGENTS_MERMAID_RULES.md`](../../../AGENTS_MERMAID_RULES.md) を必ず参照してください。

---

# 4. 機能設計

## 4.1. 機能フロー

### F001: ユーザー登録処理

ユーザーが新規登録を行う際の処理フロー。

```mermaid
flowchart TD
    Start([開始]) --> A["入力値のバリデーション"]
    A --> B{"バリデーション成功?"}
    
    B -- No --> C["エラーメッセージ表示"]
    C --> End([終了])
    
    B -- Yes --> D["メールアドレスの重複チェック"]
    D --> E{"重複なし?"}
    
    E -- No --> F["エラーメッセージ表示<br/>（メールアドレス重複）"]
    F --> End
    
    E -- Yes --> G["パスワードのハッシュ化"]
    G --> H["トランザクション開始"]
    H --> I["ユーザー情報の保存"]
    I --> J{"保存成功?"}
    
    J -- No --> K["ロールバック"]
    K --> L["エラーメッセージ表示"]
    L --> End
    
    J -- Yes --> M["確認メール送信"]
    M --> N{"メール送信成功?"}
    
    N -- No --> O["ログ出力<br/>（メール送信失敗）"]
    O --> P["コミット"]
    P --> Q["成功メッセージ表示"]
    Q --> End
    
    N -- Yes --> P
```

### 処理説明

1. **入力値のバリデーション**: 入力された値が仕様に適合しているかチェック
2. **メールアドレスの重複チェック**: 既存のユーザーとメールアドレスが重複していないかチェック
3. **パスワードのハッシュ化**: セキュリティのため、パスワードをハッシュ化
4. **ユーザー情報の保存**: データベースにユーザー情報を保存
5. **確認メール送信**: 登録完了の確認メールを送信

---

### F002: 注文処理

ユーザーが商品を注文する際の処理フロー。

```mermaid
flowchart TD
    Start([開始]) --> A["注文情報の取得"]
    A --> B["在庫数の確認"]
    B --> C{"在庫が十分?"}
    
    C -- No --> D["エラーメッセージ表示<br/>（在庫不足）"]
    D --> End([終了])
    
    C -- Yes --> E["トランザクション開始"]
    E --> F["注文情報の保存"]
    F --> G{"保存成功?"}
    
    G -- No --> H["ロールバック"]
    H --> I["エラーメッセージ表示"]
    I --> End
    
    G -- Yes --> J["注文明細の保存"]
    J --> K{"保存成功?"}
    
    K -- No --> H
    
    K -- Yes --> L["在庫数の減算"]
    L --> M{"減算成功?"}
    
    M -- No --> H
    
    M -- Yes --> N["合計金額の計算"]
    N --> O["注文情報の更新"]
    O --> P{"更新成功?"}
    
    P -- No --> H
    
    P -- Yes --> Q["コミット"]
    Q --> R["注文確認メール送信"]
    R --> S["成功メッセージ表示"]
    S --> End
```

### 処理説明

1. **注文情報の取得**: ユーザーが入力した注文情報を取得
2. **在庫数の確認**: 注文する商品の在庫が十分かチェック
3. **注文情報の保存**: データベースに注文情報を保存
4. **注文明細の保存**: データベースに注文明細を保存
5. **在庫数の減算**: 注文した商品の在庫数を減算
6. **合計金額の計算**: 注文の合計金額を計算
7. **注文確認メール送信**: 注文完了の確認メールを送信

---

## 4.2. シーケンス図

### S001: ユーザー登録シーケンス

ユーザー登録処理のシーケンス図。

```mermaid
sequenceDiagram
    actor U as "ユーザー"
    participant W as "Webアプリケーション"
    participant API as "APIサーバー"
    participant DB as "データベース"
    participant Mail as "メール配信サービス"

    U->>W: "登録情報入力"
    W->>W: "入力値のバリデーション"
    W->>API: "登録リクエスト送信"
    API->>DB: "メールアドレスの重複チェック"
    DB-->>API: "重複なし"
    API->>API: "パスワードのハッシュ化"
    API->>DB: "ユーザー情報の保存"
    DB-->>API: "保存成功"
    API->>Mail: "確認メール送信"
    Mail-->>API: "送信成功"
    API-->>W: "登録成功レスポンス"
    W-->>U: "登録完了メッセージ表示"
```

---

### S002: 注文処理シーケンス

注文処理のシーケンス図。

```mermaid
sequenceDiagram
    actor U as "ユーザー"
    participant W as "Webアプリケーション"
    participant API as "APIサーバー"
    participant DB as "データベース"
    participant Mail as "メール配信サービス"

    U->>W: "注文情報入力"
    W->>API: "注文リクエスト送信"
    API->>DB: "在庫数の確認"
    DB-->>API: "在庫あり"
    API->>DB: "トランザクション開始"
    API->>DB: "注文情報の保存"
    DB-->>API: "保存成功"
    API->>DB: "注文明細の保存"
    DB-->>API: "保存成功"
    API->>DB: "在庫数の減算"
    DB-->>API: "減算成功"
    API->>DB: "合計金額の計算・更新"
    DB-->>API: "更新成功"
    API->>DB: "コミット"
    API->>Mail: "注文確認メール送信"
    Mail-->>API: "送信成功"
    API-->>W: "注文成功レスポンス"
    W-->>U: "注文完了メッセージ表示"
```

---

## 4.3. バッチ処理仕様

### B001: 期限切れデータ削除処理

夜間に実行される「期限切れデータ削除処理」のロジック。

```mermaid
flowchart TD
    Start([開始]) --> A["対象データ抽出<br/>（期限切れデータ）"]
    A --> B{"データが存在するか?"}
    
    B -- No --> C["処理スキップ"]
    C --> End([終了])
    
    B -- Yes --> D["トランザクション開始"]
    D --> E["論理削除フラグ更新<br/>（is_deleted = 1）"]
    E --> F{"更新成功?"}
    
    F -- No --> G["ロールバック"]
    G --> H["ログ出力: 失敗"]
    H --> End
    
    F -- Yes --> I["コミット"]
    I --> J["ログ出力: 成功<br/>（削除件数: N件）"]
    J --> End
```

### 処理仕様

| 項目               | 内容                                      |
| ------------------ | ----------------------------------------- |
| 実行タイミング     | 毎日 02:00（JST）                         |
| 対象データ         | 期限切れデータ（`expired_at` < 現在日時） |
| 処理内容           | 論理削除フラグ（`is_deleted`）を 1 に更新 |
| エラーハンドリング | エラー発生時はロールバックし、ログに記録  |

---

## 4.4. API 仕様

### API001: ユーザー登録API

ユーザーを新規登録するAPI。

**エンドポイント**: `POST /api/users/register`

#### リクエスト

**ヘッダー**:
```
Content-Type: application/json
```

**ボディ**:
```json
{
  "user_name": "山田太郎",
  "email": "yamada@example.com",
  "password": "password123",
  "password_confirm": "password123",
  "gender": 1
}
```

#### レスポンス

**成功時（200 OK）**:
```json
{
  "success": true,
  "message": "ユーザー登録が完了しました",
  "data": {
    "user_id": 1
  }
}
```

**エラー時（400 Bad Request）**:
```json
{
  "success": false,
  "message": "バリデーションエラー",
  "errors": [
    {
      "field": "email",
      "message": "このメールアドレスは既に登録されています"
    }
  ]
}
```

---

### API002: 注文作成API

注文を作成するAPI。

**エンドポイント**: `POST /api/orders`

#### リクエスト

**ヘッダー**:
```
Content-Type: application/json
Authorization: Bearer {token}
```

**ボディ**:
```json
{
  "items": [
    {
      "product_id": 1,
      "quantity": 2
    },
    {
      "product_id": 2,
      "quantity": 1
    }
  ]
}
```

#### レスポンス

**成功時（200 OK）**:
```json
{
  "success": true,
  "message": "注文が完了しました",
  "data": {
    "order_id": 1,
    "total_amount": 5000.00
  }
}
```

**エラー時（400 Bad Request）**:
```json
{
  "success": false,
  "message": "在庫が不足しています",
  "errors": [
    {
      "field": "items[0].quantity",
      "message": "在庫数が不足しています"
    }
  ]
}
```

---

## 参考資料

### プロジェクトドキュメント

- [01 システム概要](../01_システム概要/README.md) - システム概要の詳細
- [02 画面設計](../02_画面設計/README.md) - 画面設計の詳細
- [03 データ設計](../03_データ設計/README.md) - データ設計の詳細

---

**最終更新**: YYYY 年 MM 月 DD 日
